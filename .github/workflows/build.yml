name: Build Debug APK (from ZIP)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install unzip
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Unzip project (auto)
        shell: bash
        run: |
          set -euo pipefail

          # Prefer your PRO zip if it exists
          if [ -f "HyperCompressor_2025_PRO.zip" ]; then
            ZIPFILE="HyperCompressor_2025_PRO.zip"
          else
            ZIPFILE="$(ls -1 *.zip 2>/dev/null | head -n 1 || true)"
          fi

          if [ -z "${ZIPFILE}" ]; then
            echo "ERROR: No ZIP found in repo root."
            ls -la
            exit 1
          fi

          echo "Using ZIP: ${ZIPFILE}"
          rm -rf project
          mkdir -p project
          unzip -o "${ZIPFILE}" -d project

      - name: Find Gradle project root
        shell: bash
        run: |
          set -euo pipefail
          ROOT_FILE="$(find project -maxdepth 12 -type f \( -name 'settings.gradle.kts' -o -name 'settings.gradle' \) -print -quit)"
          if [ -z "${ROOT_FILE}" ]; then
            echo "ERROR: settings.gradle(.kts) not found inside zip."
            find project -maxdepth 5 -type f | head -n 200 || true
            exit 1
          fi
          ROOT_DIR="$(dirname "${ROOT_FILE}")"
          echo "ROOT_DIR=${ROOT_DIR}" >> "${GITHUB_ENV}"
          echo "Project root: ${ROOT_DIR}"

      - name: Hotfix resources (ShapeAppearanceOverlay) if missing
        shell: bash
        run: |
          set -euo pipefail
          VALUES_DIR="${ROOT_DIR}/app/src/main/res/values"
          mkdir -p "${VALUES_DIR}"

          # If style missing, create it
          if ! grep -R --include='*.xml' -n 'name="ShapeAppearanceOverlay.App"' "${VALUES_DIR}" >/dev/null 2>&1; then
            cat > "${VALUES_DIR}/hyper_hotfix.xml" <<'XML'
<resources>
  <style name="ShapeAppearanceOverlay.App">
    <item name="cornerFamily">rounded</item>
    <item name="cornerSize">16dp</item>
  </style>

  <style name="ShapeAppearanceOverlay.App.Round16">
    <item name="cornerFamily">rounded</item>
    <item name="cornerSize">16dp</item>
  </style>
</resources>
XML
          fi

      - name: Patch crash on real phones (WorkManager ForegroundService type)
        shell: bash
        run: |
          set -euo pipefail

          WORKER="$(find "${ROOT_DIR}" -type f -name 'CompressWorker.kt' -print -quit || true)"
          if [ -z "${WORKER}" ]; then
            echo "ERROR: CompressWorker.kt not found"
            exit 1
          fi

          # IMPORTANT:
          # WorkManager's internal foreground service commonly declares dataSync.
          # mediaProcessing can crash on Android 13- and can mismatch on Android 14+.
          sed -i 's/FOREGROUND_SERVICE_TYPE_MEDIA_PROCESSING/FOREGROUND_SERVICE_TYPE_DATA_SYNC/g' "${WORKER}"

          MANIFEST="$(find "${ROOT_DIR}/app/src/main" -maxdepth 1 -type f -name 'AndroidManifest.xml' -print -quit || true)"
          if [ -n "${MANIFEST}" ]; then
            # Add permission for Android 14+ (safe no-op on older)
            if ! grep -q 'FOREGROUND_SERVICE_DATA_SYNC' "${MANIFEST}"; then
              perl -0777 -i -pe 's#(<uses-permission[^>]*android:name="android\.permission\.FOREGROUND_SERVICE"[^>]*/>\s*)#$1  <uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />\n#s' "${MANIFEST}" || true
            fi
          fi

          echo "Patched: ForegroundServiceType -> DATA_SYNC"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install SDK packages
        run: sdkmanager --install "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v4

      - name: Build Debug APK
        shell: bash
        run: |
          set -euo pipefail
          cd "${ROOT_DIR}"
          chmod +x ./gradlew || true
          ./gradlew :app:assembleDebug --no-daemon --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: |
            **/app/build/outputs/apk/debug/*.apk 
